{% extends "template.twig" %}
{% block title %}Checkin{% endblock %}
{% block section %}dayof{% endblock %}
{% block subnav %}{% include "dayof/subnav.twig" %}{% endblock %}
{% block content %}
    <header>
        <h2>Checkin</h2>
        <p>You can use this to check in attendees at the door.</p>
        <p>Type first name, last name, or email to filter the attendee list. Click the button next to an attendee to
           toggle checkin status.</p>
        <p>If only one attendee is showing, you can also press enter directly from the search box.</p>
        <p><strong>If "missing" shows "parent info" or "waiver", please collect it from the participant!</strong></p>
    </header>

        <input type="text" id="search" placeholder="Search by name or email" value="" autocomplete="off" />
        <style type="text/css">
            .checked-in td {
                text-decoration: line-through;
                opacity: 0.3;
            }

            #search {
                width: 100%;
                text-align: center;
                margin-bottom: 2rem;
            }

            #registrants {
                width: 100%;
            }
        </style>
        <table id="registrants" class="checkin">
            <thead>
                <tr>
                    <th class="name">Name</th>
                    <th class="email">Email</th>
                    <th class="id">Ticket</th>
                    <th class="type">Type</th>
                    <th class="missing">Missing</th>
                    <th class="action">Check In?</th>
                </tr>
            </thead>
            <tbody>
                {% for registration in event.registrations %}
                    <tr class="type-{{ registration.type }}
                        {% if registration.checked_in_at %}checked-in{% endif %}
                        ">
                        <td class="name">{{ registration.name }}</td>
                        <td class="email">{{ registration.email }}</td>
                        <td class="id">{{ registration.id }}</td>
                        <td class="type">{{ registration.type }}</td>
                        <td class="missing">
                            {% if not registration.parent_email and not registration.parent_no_info %}
                                <a href="/e/parent?r={{ registration.id }}" target="_blank">parent info</a>{% if not registration.waiver_pdf_link %},{% endif %}
                            {% endif %}
                            {% if not registration.waiver_pdf_link and (registration.type == 'student' or registration.type == 'volunteer')%}
                                waiver
                            {% endif %}
                        </td>
                        <td class="action">
                            <form class="checkin" method="post">
                                <input type="hidden" name="id" value="{{ registration.id }}" />
                                <input type="hidden" name="action" value="{% if registration.checked_in_at %}out{% else %}in{% endif %}"/>
                                <input type="submit" value="{% if registration.checked_in_at %}Undo{% else %}Checkin{% endif %}" />
                            </form>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        <h3>Android App</h3>
        <p><a href="https://play.google.com/store/apps/details?id=org.srnd.codeday.clear.checkin">Download the Android App,</a> then scan this barcode to check people in to this event:</p>
        <p><img src="/dayof/checkin/configuration?cachebreak={{ random() }}" /></p>
{% endblock %}
{% block scripts %}
    <script type="application/javascript">
        $('#search').on('keyup', function(e) {
            e.preventDefault();
            e.stopPropagation();

            var search = $(this).val();

            $('#registrants tr').each(function(i, elem) {
                var name = "" + $(elem).children('.name').text();
                var email = "" + $(elem).children('.email').text();
                var id = "" + $(elem).children('.id').text();

                if (name.toUpperCase().indexOf(search.toUpperCase()) >= 0
                        || email.toUpperCase().indexOf(search.toUpperCase()) >= 0
                        || id.toUpperCase().indexOf(search.toUpperCase()) >= 0
                    || search == "") {
                    $(this).css('display', 'table-row');
                } else {
                    $(this).css('display', 'none');
                }
            });

            if (e.which == 13) {
                if ($('#registrants tr:visible').length === 1) {
                    $('#registrants tr:visible input[type="submit"]').click();
                }
            }

            return false;
        });
        $('form.checkin').on('submit', function(e){
            e.preventDefault();
            e.stopPropagation();

            var _this = $(this);
            var id = $(this).children('input[name="id"]').val();
            var action = $(this).children('input[name="action"]').val();

            $.ajax({
                type: 'POST',
                dataType: 'json',
                url: '/dayof/checkin?event={{ event.id }}',
                data: {
                    id: id,
                    action: action,
                    "_token": "{{csrf_token|raw}}"
                },
                success: function(data) {
                    if (action == 'in') {
                        _this.parent().parent().addClass('checked-in');
                        _this.children('input[name="action"]').val('out');
                        _this.children('input[type="submit"]').val('Undo');
                    } else {
                        _this.parent().parent().removeClass('checked-in');
                        _this.children('input[name="action"]').val('in');
                        _this.children('input[type="submit"]').val('Checkin');
                    }
                    $('#search').val('').trigger('keyup').focus();
                },
                error: function(error) {
                    swal({
                        title: 'Something has gone wrong.',
                        text: error,
                        type: 'error'
                    });
                }
            });

            return false;
        });
    </script>
{% endblock %}
